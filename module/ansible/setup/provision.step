#!/usr/bin/env bash
blackbox.module.ansible.setup.provision() {
  typeset -a args=("$@")

  blackbox.trace.entrypoint privision.step "${FUNCNAME[0]}" "$*" "$(printf "BLACKBOX_PROVISION_WITH_OPTS=%s" "$BLACKBOX_PROVISION_WITH_OPTS")"

  if ( ! blackbox.flag.enabled STEP_PROVISION ); then
    printf "\n"
    printf "skip: BLACKBOX_FLAG__STEP_PROVISION=no\n"

    return
  fi

  printf "\n"
  blackbox.inventory.provision docker-ce && {
    usermod -a -G docker "$BLACKBOX_USER_NAME"
    service docker start
  }
  blackbox.inventory.provision ansible python-docker
  blackbox.inventory.install.file /etc/blackbox/ansible/playbook.yml 0 0 </blackbox/module/ansible/setup/rootfs/etc/blackbox/ansible/playbook.yml
  blackbox.inventory.install.file playbook.yml </blackbox/module/ansible/setup/rootfs/home/%/%/playbook.yml

  if [ -n "$BLACKBOX_PROVISION_WITH_OPTS" ]; then
    printf "\n"
    printf "BLACKBOX_PROVISION_WITH_OPTS=%s\n" "$BLACKBOX_PROVISION_WITH_OPTS"
    eval "$BLACKBOX_PROVISION_WITH_OPTS"
    printf "\n"
    blackbox.environment.load
  fi
}; blackbox.module.ansible.setup.provision "$@"
