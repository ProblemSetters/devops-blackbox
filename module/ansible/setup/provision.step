#!/usr/bin/env bash

blackbox.module.ansible.setup.provision() {
  typeset question_id=$1

  if ( blackbox.flag.enabled DEBUG_MODE ); then
    printf "\n"
    printf "\033[0;37m%s\033[0m\n" "${FUNCNAME[0]}"
    printf "\033[0;34m[PROVISION]\033[0m\n"
  else
    printf "\n"
    printf "[PROVISION]\n"
  fi

  blackbox.inventory.provision docker-ce && {
    usermod -aG docker "$BLACKBOX_HOST_USERNAME"
    service docker start
  }

  blackbox.inventory.provision ansible python-docker && {
    blackbox.transport.fetch module/ansible/setup/rootfs/etc/blackbox/ansible/playbook.yml | install -m 0644 -D /dev/stdin /etc/blackbox/ansible/playbook.yml
  }

  install -o "$BLACKBOX_HOST_USERNAME" -g "$(getent group "$BLACKBOX_HOST_USERNAME" | cut -d ":" -f 1)" -m 0775 -d "/home/${BLACKBOX_HOST_USERNAME}/${question_id}" && {
    blackbox.transport.fetch module/ansible/setup/rootfs/home/%/%/playbook.yml | install -o "$BLACKBOX_HOST_USERNAME" -g "$(getent group "$BLACKBOX_HOST_USERNAME" | cut -d ":" -f 1)" -m 0664 /dev/stdin "/home/${BLACKBOX_HOST_USERNAME}/${question_id}/playbook.yml"
  }
}; blackbox.module.ansible.setup.provision "$@"
